@page "/readings"
@inject ApiClient ApiClient

<PageTitle>Readings</PageTitle>

<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-2">
    <div>
        <h1 class="mb-0">Reading history</h1>
        <p class="text-muted mb-0">Capture the Sunday you read a psalm. Only the date is stored.</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenCreate">Add reading</button>
</div>

@if (_loadError is not null)
{
    <div class="alert alert-danger">@_loadError</div>
}

@if (_saveMessage is not null)
{
    <div class="alert alert-success">@_saveMessage</div>
}
@if (_saveError is not null)
{
    <div class="alert alert-danger">@_saveError</div>
}

<div class="card shadow-sm">
    <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
            <h5 class="card-title mb-0">History</h5>
            <div class="d-flex flex-wrap gap-2">
                <InputDate @bind-Value="_filterFrom" class="form-control" placeholder="From" />
                <InputDate @bind-Value="_filterTo" class="form-control" placeholder="To" />
                <button class="btn btn-outline-secondary" @onclick="LoadReadings" disabled="isLoading">Apply</button>
                <button class="btn btn-link text-decoration-none" @onclick="ResetFilters" disabled="isLoading">Reset</button>
            </div>
        </div>

        @if (_isLoading)
        {
            <p><em>Loading readings...</em></p>
        }
        else if (_readings.Count == 0)
        {
            <p>No readings recorded.</p>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th style="width: 18%">Date</th>
                            <th style="width: 12%">Psalm</th>
                            <th>Title</th>
                            <th style="width: 15%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var record in _readings.OrderByDescending(r => r.DateRead))
                        {
                            <tr>
                                <td>@record.DateRead.ToString("yyyy-MM-dd")</td>
                                <td>@record.PsalmId</td>
                                <td>@GetPsalmTitle(record.PsalmId)</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" @onclick="() => StartEdit(record)">Edit</button>
                                        <button class="btn btn-outline-danger" @onclick="() => DeleteReading(record.Id)">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@if (_showModal)
{
    <div class="modal fade show" style="display:block;" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@FormTitle</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CancelEdit"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Psalm</label>
                        <select class="form-select" @bind="_selectedPsalmId">
                            <option value="0">Select a psalm</option>
                            @foreach (var psalm in _psalms)
                            {
                                <option value="@psalm.Id">@psalm.Id - @psalm.Title</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date read</label>
                        <InputDate @bind-Value="_dateRead" class="form-control" />
                    </div>
                    @if (_modalError is not null)
                    {
                        <div class="alert alert-danger">@_modalError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelEdit" disabled="@_isSaving">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveReading" disabled="@(_isSaving || _selectedPsalmId <= 0)">
                        @(_isSaving ? "Saving..." : SubmitLabel)
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<PsalmDto> _psalms = [];
    private List<ReadingRecordDto> _readings = [];
    private bool _isLoading = true;
    private bool _isSaving;
    private string? _loadError;
    private string? _saveError;
    private string? _saveMessage;
    private int _selectedPsalmId;
    private DateOnly _dateRead = DateOnly.FromDateTime(DateTime.Today);
    private DateOnly? _filterFrom;
    private DateOnly? _filterTo;
    private Guid? _editingId;
    private bool _showModal;
    private string? _modalError;
    private string FormTitle => _editingId is null ? "Add reading" : "Edit reading";
    private string SubmitLabel => _editingId is null ? "Save" : "Update";

    protected override async Task OnInitializedAsync()
    {
        await LoadPsalms();
        await LoadReadings();
    }

    private async Task LoadPsalms()
    {
        try
        {
            _psalms = (await ApiClient.GetPsalmsAsync()).OrderBy(p => p.Id).ToList();
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
        }
    }

    private async Task LoadReadings()
    {
        try
        {
            _loadError = null;
            _isLoading = true;
            _readings = (await ApiClient.GetReadingsAsync(_filterFrom, _filterTo)).ToList();
        }
        catch (Exception ex)
        {
            _loadError = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveReading()
    {
        if (_selectedPsalmId <= 0)
        {
            _saveError = "Please select a psalm.";
            return;
        }

        try
        {
            _saveError = null;
            _saveMessage = null;
            _modalError = null;
            _isSaving = true;

            if (await HasDuplicateReading(_selectedPsalmId, _dateRead, _editingId))
            {
                _modalError = "This psalm already has a reading on that date.";
                return;
            }

            if (_editingId is null)
            {
                await ApiClient.CreateReadingAsync(new CreateReadingRequest(_selectedPsalmId, _dateRead));
                _saveMessage = "Reading saved.";
            }
            else
            {
                await ApiClient.UpdateReadingAsync(_editingId.Value, new UpdateReadingRequest(_selectedPsalmId, _dateRead));
                _saveMessage = "Reading updated.";
            }

            await LoadReadings();
            CloseModal();
        }
        catch (Exception ex)
        {
            _modalError = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void StartEdit(ReadingRecordDto record)
    {
        _editingId = record.Id;
        _selectedPsalmId = record.PsalmId;
        _dateRead = record.DateRead;
        _saveMessage = null;
        _saveError = null;
        _modalError = null;
        _showModal = true;
    }

    private void OpenCreate()
    {
        _editingId = null;
        _selectedPsalmId = 0;
        _dateRead = DateOnly.FromDateTime(DateTime.Today);
        _modalError = null;
        _showModal = true;
    }

    private void CancelEdit()
    {
        CloseModal();
    }

    private void CloseModal()
    {
        _editingId = null;
        _selectedPsalmId = 0;
        _dateRead = DateOnly.FromDateTime(DateTime.Today);
        _saveMessage = null;
        _saveError = null;
        _modalError = null;
        _showModal = false;
    }

    private async Task DeleteReading(Guid id)
    {
        var confirm = await JsConfirm("Delete this reading? This cannot be undone.");
        if (!confirm)
        {
            return;
        }

        try
        {
            _isSaving = true;
            await ApiClient.DeleteReadingAsync(id);
            await LoadReadings();
            if (_editingId == id)
            {
                CancelEdit();
            }
        }
        catch (Exception ex)
        {
            _saveError = ex.Message;
        }
        finally
        {
            _isSaving = false;
        }
    }

    [Inject] private IJSRuntime JsRuntime { get; set; } = default!;

    private async Task<bool> JsConfirm(string message)
    {
        try
        {
            return await JsRuntime.InvokeAsync<bool>("confirm", message);
        }
        catch
        {
            return false;
        }
    }

    private void ResetFilters()
    {
        _filterFrom = null;
        _filterTo = null;
        _ = LoadReadings();
    }

    private string GetPsalmTitle(int id) =>
        _psalms.FirstOrDefault(p => p.Id == id)?.Title ?? "(not loaded)";

    private async Task<bool> HasDuplicateReading(int psalmId, DateOnly date, Guid? excludeId)
    {
        // Best-effort client-side check; API enforces uniqueness.
        var allReadings = await ApiClient.GetReadingsAsync();
        return allReadings.Any(r => r.PsalmId == psalmId && r.DateRead == date && r.Id != excludeId);
    }
}
