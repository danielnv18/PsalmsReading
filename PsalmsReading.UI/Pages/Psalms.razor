@page "/psalms"
@inject ApiClient ApiClient

<PageTitle>Psalms</PageTitle>

<h1>Psalms catalog</h1>
<p class="text-muted">Data comes from <code>psalms_full_list.csv</code> imported into the database.</p>

<div class="mb-3">
    <input class="form-control" placeholder="Filter by title, type, theme, or epigraph..." @bind="_searchTerm" @bind:event="oninput" />
</div>

@if (_error is not null)
{
    <div class="alert alert-danger">@_error</div>
}
else if (_isLoading)
{
    <p><em>Loading psalms...</em></p>
}
else if (_filtered.Count == 0)
{
    <p>No psalms found.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th style="width:5%">Id</th>
                    <th>Title</th>
                    <th style="width:10%">Type</th>
                    <th style="width:10%">Verses</th>
                    <th style="width:20%">Themes</th>
                    <th style="width:20%">Epigraphs</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var psalm in _filtered)
                {
                    <tr>
                        <td>@psalm.Id</td>
                        <td>@psalm.Title</td>
                        <td>@(psalm.Type ?? "-")</td>
                        <td>@psalm.TotalVerses</td>
                        <td>@(psalm.Themes.Count == 0 ? "-" : string.Join(", ", psalm.Themes))</td>
                        <td>@(psalm.Epigraphs.Count == 0 ? "-" : string.Join(", ", psalm.Epigraphs))</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<PsalmDto> _psalms = [];
    private List<PsalmDto> _filtered = [];
    private bool _isLoading = true;
    private string? _error;
    private string _searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _error = null;
            _isLoading = true;
            _psalms = (await ApiClient.GetPsalmsAsync()).OrderBy(p => p.Id).ToList();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            _filtered = _psalms;
            return;
        }

        var term = _searchTerm.Trim();
        _filtered = _psalms
            .Where(p =>
                p.Title.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (p.Type?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                p.Themes.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                p.Epigraphs.Any(e => e.Contains(term, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }
}
