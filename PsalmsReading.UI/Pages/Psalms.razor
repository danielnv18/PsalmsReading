@page "/psalms"
@inject ApiClient ApiClient

<PageTitle>Psalms</PageTitle>

<h1>Psalms catalog</h1>
<p class="text-muted">Data comes from <code>psalms_full_list.csv</code> imported into the database.</p>

<div class="mb-3">
    <input class="form-control" placeholder="Filter by title, type, theme, or epigraph..." @bind="searchTerm" @bind:event="oninput" />
</div>

@if (error is not null)
{
    <div class="alert alert-danger">@error</div>
}
else if (isLoading)
{
    <p><em>Loading psalms...</em></p>
}
else if (filtered.Count == 0)
{
    <p>No psalms found.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th style="width:5%">Id</th>
                    <th>Title</th>
                    <th style="width:10%">Type</th>
                    <th style="width:10%">Verses</th>
                    <th style="width:20%">Themes</th>
                    <th style="width:20%">Epigraphs</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var psalm in filtered)
                {
                    <tr>
                        <td>@psalm.Id</td>
                        <td>@psalm.Title</td>
                        <td>@(psalm.Type ?? "-")</td>
                        <td>@psalm.TotalVerses</td>
                        <td>@(psalm.Themes.Count == 0 ? "-" : string.Join(", ", psalm.Themes))</td>
                        <td>@(psalm.Epigraphs.Count == 0 ? "-" : string.Join(", ", psalm.Epigraphs))</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<PsalmDto> psalms = new();
    private List<PsalmDto> filtered = new();
    private bool isLoading = true;
    private string? error;
    private string searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            error = null;
            isLoading = true;
            psalms = (await ApiClient.GetPsalmsAsync()).OrderBy(p => p.Id).ToList();
            ApplyFilter();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = psalms;
            return;
        }

        var term = searchTerm.Trim();
        filtered = psalms
            .Where(p =>
                p.Title.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (p.Type?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false) ||
                p.Themes.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)) ||
                p.Epigraphs.Any(e => e.Contains(term, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }
}
