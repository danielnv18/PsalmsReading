@page "/psalms"
@inject ApiClient ApiClient

<PageTitle>Psalms</PageTitle>

<h1>Psalms catalog</h1>
<p class="text-muted">Data comes from <code>psalms_full_list.csv</code> imported into the database.</p>

<div class="mb-3">
    <input class="form-control" placeholder="Filter by title or type..." @bind="_searchTerm" @bind:event="oninput" />
</div>

@if (_error is not null)
{
    <div class="alert alert-danger">@_error</div>
}
else if (_isLoading)
{
    <p><em>Loading psalms...</em></p>
}
else if (_filtered.Count == 0)
{
    <p>No psalms found.</p>
}
else
{
    <div class="d-flex flex-wrap gap-2 mb-3">
        <span class="type-badge type-lamento">Lamento</span>
        <span class="type-badge type-alabanza">Alabanza</span>
        <span class="type-badge type-himno">Himno</span>
        <span class="type-badge type-realeza">Realeza</span>
        <span class="type-badge type-sabiduria">Sabiduria</span>
        <span class="type-badge type-agradecimiento">Agradecimiento</span>
        <span class="type-badge type-confianza">Confianza</span>
    </div>
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th style="width:5%">Id</th>
                    <th>Title</th>
                    <th style="width:10%">Type</th>
                    <th style="width:10%">Verses</th>
                    <th style="width:18%">Reading stats</th>
                    <th style="width:12%">Bible.com</th>
                </tr>
            </thead>
            <tbody>
                @foreach (PsalmDto psalm in _filtered)
                {
                    PsalmReadingStats stats = GetReadingStats(psalm.Id);
                    <tr>
                        <td>@psalm.Id</td>
                        <td>@psalm.Title</td>
                        <td>
                            @if (string.IsNullOrWhiteSpace(psalm.Type))
                            {
                                <span>-</span>
                            }
                            else
                            {
                                <span class="type-badge @GetTypeClass(psalm.Type)">@psalm.Type</span>
                            }
                        </td>
                        <td>@psalm.TotalVerses</td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <span>@stats.ReadCount read(s)</span>
                                <span class="text-muted">Last: @(stats.LastRead is null ? "-" : stats.LastRead.Value.ToString("yyyy-MM-dd"))</span>
                            </div>
                        </td>
                        <td>
                            <a class="link-primary" href="@GetBibleLink(psalm.Id)" target="_blank" rel="noopener noreferrer">
                                Read
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<PsalmDto> _psalms = [];
    private List<PsalmDto> _filtered = [];
    private List<ReadingRecordDto> _readings = [];
    private Dictionary<int, PsalmReadingStats> _readingStats = [];
    private bool _isLoading = true;
    private string? _error;
    private string _searchTerm = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _error = null;
            _isLoading = true;
            _psalms = (await ApiClient.GetPsalmsAsync()).OrderBy(p => p.Id).ToList();
            _readings = (await ApiClient.GetReadingsAsync()).ToList();
            _readingStats = BuildReadingStats(_readings);
            ApplyFilter();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            _filtered = _psalms;
            return;
        }

        string term = _searchTerm.Trim();
        _filtered = _psalms
            .Where(p =>
                p.Title.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                (p.Type?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }

    private static string GetTypeClass(string type)
    {
        string key = type.Trim().ToLowerInvariant();
        return key switch
        {
            "lamento" => "type-lamento",
            "alabanza" => "type-alabanza",
            "himno" => "type-himno",
            "realeza" => "type-realeza",
            "sabiduria" => "type-sabiduria",
            "sabiduría" => "type-sabiduria",
            "agradecimiento" => "type-agradecimiento",
            "confianza" => "type-confianza",
            _ => "type-unknown"
        };
    }

    private static Dictionary<int, PsalmReadingStats> BuildReadingStats(IEnumerable<ReadingRecordDto> readings)
    {
        Dictionary<int, PsalmReadingStats> stats = new();
        foreach (ReadingRecordDto reading in readings)
        {
            if (!stats.TryGetValue(reading.PsalmId, out PsalmReadingStats? current))
            {
                stats[reading.PsalmId] = new PsalmReadingStats(1, reading.DateRead);
                continue;
            }

            int readCount = current.ReadCount + 1;
            DateOnly? lastRead = current.LastRead;
            if (lastRead is null || reading.DateRead > lastRead)
            {
                lastRead = reading.DateRead;
            }

            stats[reading.PsalmId] = new PsalmReadingStats(readCount, lastRead);
        }

        return stats;
    }

    private PsalmReadingStats GetReadingStats(int psalmId) =>
        _readingStats.TryGetValue(psalmId, out PsalmReadingStats? stats)
            ? stats
            : new PsalmReadingStats(0, null);

    private static string GetBibleLink(int psalmId) =>
        $"https://www.bible.com/bible/103/PSA.{psalmId}.NBLA";

    private sealed record PsalmReadingStats(int ReadCount, DateOnly? LastRead);
}
